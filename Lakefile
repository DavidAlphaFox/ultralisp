#|-*- mode:lisp -*-|#
;; (in-package :cl-user)
(defpackage :lake.user
  (:use :cl :lake :cl-syntax)
  (:shadowing-import-from :lake
                          :directory))
(in-package :lake.user)

(use-syntax :interpol)

(defun get-current-version ()
  (uiop:read-file-form "version.lisp-expr"))


(defvar tag #?"40ants/ultralisp:${(get-current-version)}")


(task "version" ()
      (format t #?"Current-version: ${(get-current-version)}~%Docker tag: ${tag}~%"))


(task "build" ()
      (sh #?"docker build --target base -t ${tag} ."))


;; TODO: remove CL_SOURCE_REGISTRY before release
(task "build-worker" ()
      (sh #?"CL_SOURCE_REGISTRY=~/common-lisp// qlot exec ros -L sbcl build ./worker.ros"))

(task "push" ("build")
      (sh #?"docker push ${tag}"))

(file "qlfile.lock" ("qlfile")
      (sh "qlot update"))

(task "deps" ("qlfile.lock")
      ;; Here you need to install gen-deps-system using this command
      ;; ros install 40ants/gen-deps-system
      (sh "qlot exec ros run --eval '(ql:quickload :ultralisp)' --eval '(uiop:quit)'")
      (sh "qlot exec gen-deps-system --except ultralisp,sb-concurrency,sb-bsd-sockets,sb-cltl2,sb-introspect,sb-posix,sb-rotate-byte,asdf app"))

(task "devserver" ("deps")
      (sh "docker-compose up --build --abort-on-container-exit app"))

(task "dump-db" ()
      (sh "docker-compose run --rm db-ops dump"))

(task "restore-db" ()
      (sh "docker stop ultralisp_app ultralisp_worker")
      (sh "docker-compose run --rm db-ops restore"))

(task "generate-migration" ()
      (sh "docker-compose rm --stop --force empty-postgres")
      (sh "docker-compose run --rm mito generate-migration"))

(task "migrate" ()
      (sh "docker-compose run --rm mito migrate"))

(task "default" ("devserver")
      ())
